@{
    Layout = "~/Views/Shared/User/_Layout.cshtml";

    @inject IHomeService HomeService
    var homeData = await HomeService.GetHomeProperties();

    var article = ViewData["Article"] as ArticleModel;

    ViewData["Title"] = article.Title;
    ViewData["Description"] = article.Excerpt;
    ViewData["canonical"] = article.FullUrl;
}

<!--
        <div class="text-left w-100">
            <h4 class="color-black mt-2 mb-2"> Dodaj swój komenatrz</h4>
            <p class="color-grey line-height-25px mb-2rem">
                Nie będę publikował twojego adresu e-mail
            </p>
        </div>

        <div class="alert alert-warning alert-dismissible fade show with-icon d-none" id="alert-add-comment"></div>

        <div class="company-contact-form">
            <div class="row">
                <div class="col-md-6 col-sm-12">
                    <div class="contact-form-textfield pb-4">
                        <input type="text" placeholder="Imię *" class="form-control" id="name" name="Name">
                    </div>
                </div>
                <div class="col-md-6 col-sm-12">
                    <div class="contact-form-textfield pb-4">
                        <input type="text" placeholder="Adres e-mail *" class="form-control" id="email" name="Email">
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="contact-form-textfield pb-4">
                        <textarea placeholder="Treść komentarza *" class="form-control message" id="content" name="Content"></textarea>
                    </div>
                </div>
                <div class="col-lg-12 pt-xs-25px">
                    <button type="submit" class="btn-setting btn-hvr-setting-main btn-yellow btn-hvr text-uppercase w-100" id="submit-add-comment">
                        SKOMENTUJ
                        <span class="btn-hvr-setting btn-hvr-pink">
                            <span class="btn-hvr-setting-inner">
                                <span class="btn-hvr-effect"></span>
                                <span class="btn-hvr-effect"></span>
                                <span class="btn-hvr-effect"></span>
                                <span class="btn-hvr-effect"></span>
                            </span>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    -->
<!-- Hero Start -->
<section class="bg-half bg-light d-table w-100">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-12 text-center">
                <div class="page-next-level">
                    <h2>@article.Title </h2>
                    <ul class="list-unstyled mt-4">
                        <li class="list-inline-item h6 user text-muted mr-2"><i class="mdi mdi-account"></i> @article.User.Name</li>
                        <li class="list-inline-item h6 date text-muted"><i class="mdi mdi-calendar-check"></i> @article.AddDate.ToString("dd-MM-yyyy")</li>
                    </ul>
                    <div class="page-next">
                        <nav aria-label="breadcrumb" class="d-inline-block">
                            <ul class="breadcrumb bg-white rounded shadow mb-0">
                                <li class="breadcrumb-item"><a href="@Url.Action("Index","Home")">Strona główna</a></li>
                                <li class="breadcrumb-item"><a href="@Url.Action("List","Blog")">Lista</a></li>
                                <li class="breadcrumb-item"><a href="#">Blog</a></li>
                                <li class="breadcrumb-item active" aria-current="page">@article.Title</li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div><!--end col-->
        </div><!--end row-->
    </div> <!--end container-->
</section><!--end section-->
<!-- Hero End -->
<!-- Shape Start -->
<div class="position-relative">
    <div class="shape overflow-hidden text-white">
        <svg viewBox="0 0 2880 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 48H1437.5H2880V0H2160C1442.5 52 720 0 720 0H0V48Z" fill="currentColor"></path>
        </svg>
    </div>
</div>
<!--Shape End-->
<!-- Blog STart -->
<section class="section">
    <div class="container">
        <div class="row">
            <!-- BLog Start -->
            <div class="col-lg-8 col-md-6">

                @if (ViewData["AddCommentSucces"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show with-icon">@ViewData["AddCommentSucces"]</div>
                }


                <div class="card blog blog-detail border-0 shadow rounded">
                    @if (article.Image != null)
                    {
                        <img src="@article.Image.Url" class="img-fluid rounded-top" alt="@article.Image.Description">
                    }
                    <div class="card-body content">
                        @Html.Raw(article.Content)
                    </div>
                </div>


                @if (homeData.BlogSettings.AllowComments && article.CommentStatus)
                {
                    @if (article.Comments.Where(c => c.IsAccepted != false).Count() != 0)
                    {
                        <div class="card shadow rounded border-0 mt-4">
                            <div class="card-body">
                                <h5 class="card-title mb-0">Comments:</h5>

                                <ul class="media-list list-unstyled mb-0">

                                    @foreach (var comment in article.Comments.Where(c => c.IsAccepted != false))
                                    {
                                        <li class="mt-4">
                                            <div class="d-flex justify-content-between">
                                                <div class="media align-items-center">
                                                    <a class="pr-3" href="#">
                                                        <img src="images/client/01.jpg" class="img-fluid avatar avatar-md-sm rounded-circle shadow" alt="img">
                                                    </a>
                                                    <div class="commentor-detail">
                                                        <h6 class="mb-0">@comment.Name</h6>
                                                        <small class="text-muted">@comment.AddDate.ToString("dd-MM-yyyy")</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <p class="text-muted font-italic p-3 bg-light rounded">@comment.Content</p>
                                            </div>
                                        </li>
                                    }

                                </ul>
                            </div>
                        </div>
                    }
                    <div class="card shadow rounded border-0 mt-4">
                        <div class="card-body">
                            <h5 class="card-title mb-0">Leave A Comment :</h5>

                            <form class="mt-3">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group position-relative">
                                            <label>Your Comment</label>
                                            <i data-feather="message-circle" class="fea icon-sm icons"></i>
                                            <textarea id="message" placeholder="Your Comment" rows="5" name="message" class="form-control pl-5" required=""></textarea>
                                        </div>
                                    </div><!--end col-->

                                    <div class="col-lg-6">
                                        <div class="form-group position-relative">
                                            <label>Name <span class="text-danger">*</span></label>
                                            <i data-feather="user" class="fea icon-sm icons"></i>
                                            <input id="name" name="name" type="text" placeholder="Name" class="form-control pl-5" required="">
                                        </div>
                                    </div><!--end col-->

                                    <div class="col-lg-6">
                                        <div class="form-group position-relative">
                                            <label>Your Email <span class="text-danger">*</span></label>
                                            <i data-feather="mail" class="fea icon-sm icons"></i>
                                            <input id="email" type="email" placeholder="Email" name="email" class="form-control pl-5" required="">
                                        </div>
                                    </div><!--end col-->

                                    <div class="col-md-12">
                                        <div class="send">
                                            <button type="submit" class="btn btn-primary btn-block">Send Message</button>
                                        </div>
                                    </div><!--end col-->
                                </div><!--end row-->
                            </form><!--end form-->
                        </div>
                    </div>
                }

            </div>
            <!-- BLog End -->
            <!-- START SIDEBAR -->
            <div class="col-lg-4 col-md-6 col-12 mt-4 mt-sm-0 pt-2 pt-sm-0">
                @await Html.PartialAsync("User/_SideBar")
            </div><!--end col-->
            <!-- END SIDEBAR -->
        </div><!--end row-->
    </div><!--end container-->
</section><!--end section-->
<!-- Blog End -->


@section homeScripts {
    <script>
        const buttonSubmit = document.querySelector("#submit-add-comment");
        const alertField = document.querySelector("#alert-add-comment");
        const contentText = document.querySelector("#content");
        const emailText = document.querySelector("#email");
        const nameText = document.querySelector("#name");

        buttonSubmit.addEventListener("click", function () {

            var data = {
                'Name': nameText.value,
                'Email': emailText.value,
                'Content': contentText.value,
                'ArticleId': @article.Id
            };

            $.ajax(
                    {
                        url: '@Url.Action("AddComment","Blog")',
                        type: "POST",
                        contentType: "application/json",
                        dataType: "json",
                        data: JSON.stringify(data),
                        success: function (result) {
                            window.location.href = "@Url.Action("Details","Blog", new { slug = article.Slug, status = "AddCommentSucces"})";
                        },
                        error: function (error) {

                            alertField.innerHTML = "";
                            alertField.classList.remove("d-none");

                            let errors = error.responseJSON;
                            for (let name in errors) {
                                // jeżeli jest więcej błędów jednego typu to przeiteruj po nich
                                if (errors[name].length != 1) {
                                    for (let subError of errors[name]) {
                                        alertField.innerHTML += `<p> ${subError} </p>`;
                                    }
                                }
                                else {
                                    alertField.innerHTML += `<p> ${errors[name]} </p>`;
                                }
                            }
                            console.log(errors);

                        }
                });

            });
    </script>
}